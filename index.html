<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task School - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        
        :root {
            --primary-orange: #d97706;
            --bg-cream: #fffaf5;
            --accent-yellow: #f59e0b;
            --soft-border: #f3e8d2;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-cream); 
            color: #4b2c20;
        }

        .hidden { display: none; }
        .is-done { opacity: 0.5; text-decoration: line-through; filter: grayscale(50%); }
        
        .note-card { 
            transition: all 0.3s ease; 
            border: 1px solid var(--soft-border);
            background: #ffffff;
            position: relative;
        }
        .note-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.1); }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
        .note-card:focus-within { z-index: 50; }
        
        .dropdown-content { 
            display: none; 
            position: absolute; 
            right: 0; 
            top: 100%; 
            background: white; 
            border: 1px solid var(--soft-border); 
            border-radius: 12px; 
            z-index: 100; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            width: 140px; 
            overflow: hidden;
        }
        
        /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠ dropdown ‡∏ñ‡∏π‡∏Å‡πÇ‡∏ü‡∏Å‡∏±‡∏™ */
        .dropdown:focus-within .dropdown-content { display: block; }

        #toast { 
            visibility: hidden; min-width: 250px; background-color: #4b2c20; 
            color: #fff; text-align: center; border-radius: 20px; padding: 16px; 
            position: fixed; z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%); 
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        .guide-text { animation: bounceSide 2s infinite; color: #a39382; }
        @keyframes bounceSide {
            0%, 20%, 50%, 80%, 100% { transform: translateX(0); }
            40% { transform: translateX(-10px); }
            60% { transform: translateX(-5px); }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-cream); }
        ::-webkit-scrollbar-thumb { background: #e5d5bc; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="toast">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-sm border border-[#f3e8d2]">
            <div class="w-20 h-20 bg-[#fef3c7] rounded-full mx-auto mb-6 flex items-center justify-center">
                <span class="text-4xl">üéì</span>
            </div>
            <h1 class="text-3xl font-bold text-center mb-2 text-[#d97706]">Task School</h1>
            <input type="text" id="nickname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" class="w-full p-4 mb-4 border border-[#f3e8d2] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] bg-[#fffcf8]">
            <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-4 mb-8 border border-[#f3e8d2] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] bg-[#fffcf8]">
            <button onclick="login()" class="w-full bg-[#d97706] text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-[#b45309] transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-24">
        <nav class="bg-white/80 backdrop-blur-md p-5 border-b border-[#f3e8d2] sticky top-0 z-40">
            <div class="max-w-4xl mx-auto flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-[#d97706]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á <span id="user-name" class="text-[#4b2c20]"></span></h2>
                <button onclick="logout()" class="text-[#a39382] text-xs font-bold uppercase tracking-widest hover:text-[#d97706]">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <div class="max-w-4xl mx-auto flex gap-3 overflow-x-auto">
                <button id="btn-all" onclick="changeView('all')" class="px-6 py-2 rounded-full bg-[#fef3c7] text-[#b45309] text-sm font-bold shadow-sm border border-[#fde68a]">‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button id="btn-trash" onclick="changeView('trash')" class="px-6 py-2 rounded-full bg-white text-[#a39382] text-sm font-bold border border-[#f3e8d2]">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</button>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-4">
            <div id="note-list" class="flex flex-col gap-4"></div>
        </div>

        <div class="fixed bottom-8 right-8 flex items-center gap-3 z-[110]">
            <span class="guide-text text-sm font-bold bg-white/90 px-4 py-2 rounded-full shadow-sm border border-[#f3e8d2]">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</span>
            <button onclick="openModal()" class="w-16 h-16 bg-[#f59e0b] text-white rounded-full text-4xl shadow-2xl flex items-center justify-center transition hover:scale-110 active:scale-95 hover:bg-[#d97706] border-4 border-white">
                <span class="mb-1">+</span>
            </button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-[#4b2c20]/40 flex items-center justify-center p-4 z-[200] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl border border-[#f3e8d2]">
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-[#4b2c20]">‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" class="w-full p-4 mb-4 border border-[#f3e8d2] bg-[#fffcf8] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] font-bold text-lg">
            <textarea id="content" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô..." class="w-full h-32 p-4 mb-4 border border-[#f3e8d2] bg-[#fffcf8] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] resize-none text-[#6b7280]"></textarea>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div>
                    <label class="block mb-2 text-xs font-bold text-[#a39382] ml-2 uppercase">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</label>
                    <input type="date" id="date" class="w-full p-4 border border-[#f3e8d2] bg-[#fffcf8] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] text-sm">
                </div>
                <div>
                    <label class="block mb-2 text-xs font-bold text-[#a39382] ml-2 uppercase">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <input type="time" id="time" class="w-full p-4 border border-[#f3e8d2] bg-[#fffcf8] rounded-2xl outline-none focus:ring-2 focus:ring-[#f59e0b] text-sm">
                </div>
            </div>
            
            <div class="flex gap-4">
                <button type="button" onclick="closeModal()" class="flex-1 p-4 text-[#a39382] font-bold hover:text-[#d97706]">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" onclick="saveNote()" id="btn-save" class="flex-1 p-4 bg-[#d97706] text-white rounded-2xl font-bold shadow-lg hover:bg-[#b45309]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        const _URL = 'https://vapsoypudgmcxpayrtug.supabase.co';
        const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcHNveXB1ZGdtY3hwYXlydHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNDMzOTUsImV4cCI6MjA4NDYxOTM5NX0.AnD5YcWiDifHVARsCejbyxyzs_yggjE3o43UHxeQ5GM';
        const supabaseClient = supabase.createClient(_URL, _KEY);

        let user = { name: '', email: '' };
        let currentView = 'all';

        window.onload = function() {
            const savedUser = localStorage.getItem('task_school_user');
            if (savedUser) { user = JSON.parse(savedUser); showDashboard(); }
        };

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function login() {
            const name = document.getElementById('nickname').value;
            const email = document.getElementById('email').value;
            if(!name || !email) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            user = { name, email };
            localStorage.setItem('task_school_user', JSON.stringify(user));
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            fetchNotes();
        }

        function logout() {
            localStorage.removeItem('task_school_user');
            location.reload();
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-all').className = view === 'all' ? 'px-6 py-2 rounded-full bg-[#fef3c7] text-[#b45309] text-sm font-bold shadow-sm border border-[#fde68a]' : 'px-6 py-2 rounded-full bg-white text-[#a39382] text-sm font-bold border border-[#f3e8d2]';
            document.getElementById('btn-trash').className = view === 'trash' ? 'px-6 py-2 rounded-full bg-[#fef3c7] text-[#b45309] text-sm font-bold shadow-sm border border-[#fde68a]' : 'px-6 py-2 rounded-full bg-white text-[#a39382] text-sm font-bold border border-[#f3e8d2]';
            fetchNotes();
        }

        async function fetchNotes() {
            const isDeleted = currentView === 'trash';
            const { data } = await supabaseClient
                .from('note')
                .select('*')
                .eq('email', user.email)
                .eq('is_deleted', isDeleted)
                .order('is_pinned', { ascending: false })
                .order('due_date', { ascending: true });

            const list = document.getElementById('note-list');
            list.innerHTML = (data && data.length) ? '' : '<div class="text-center py-20 text-[#a39382]">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ</div>';
            
            if(data) data.forEach(n => {
                const rawDate = n.due_date.replace('T', ' ');
                const [d, t] = rawDate.split(' ');
                const [y, m, day] = d.split('-');
                const displayTime = t ? t.substring(0, 5) : "00:00";
                const displayDateTime = `${day}/${m}/${parseInt(y)+543} ${displayTime}`;

                list.innerHTML += `
                <div class="note-card p-6 rounded-[2rem] relative ${n.is_done ? 'is-done' : ''} ${n.is_pinned ? 'bg-[#fffbeb] border-[#fde68a]' : 'bg-white'}" tabindex="0">
                    ${n.is_pinned ? '<span class="absolute -top-2 -left-2 bg-[#f59e0b] text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-sm">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>' : ''}
                    <div class="flex items-start gap-4">
                        <input type="checkbox" ${n.is_done ? 'checked' : ''} onchange="toggleDone(${n.id}, ${n.is_done})" class="mt-1.5 w-6 h-6 rounded-full border-[#f3e8d2] text-[#d97706] focus:ring-[#f59e0b]">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1 text-[#4b2c20]">${n.title}</h4>
                            <p class="text-[#6b7280] text-sm mb-4 whitespace-pre-wrap leading-relaxed">${n.content || ''}</p>
                            <div class="text-[11px] font-bold text-[#b45309] bg-[#fef3c7] inline-block px-4 py-1.5 rounded-full">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${displayDateTime}</div>
                        </div>
                        <div class="dropdown relative">
                            <button class="p-2 text-[#d1d5db] hover:text-[#d97706] text-xl focus:outline-none">‚ãÆ</button>
                            <div class="dropdown-content">
                                ${isDeleted ? `<button onclick="restoreNote(${n.id})" class="w-full text-left p-3 text-sm font-bold text-[#d97706] hover:bg-[#fffaf5]">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>` : 
                                `<button onclick="togglePin(${n.id}, ${n.is_pinned})" class="w-full text-left p-3 text-sm font-bold text-[#b45309] border-b border-[#fffaf5] hover:bg-[#fffaf5]">${n.is_pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î'}</button>
                                 <button onclick='editNote(${JSON.stringify(n)})' class="w-full text-left p-3 text-sm font-bold text-[#4b2c20] border-b border-[#fffaf5] hover:bg-[#fffaf5]">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                 <button onclick="moveToTrash(${n.id})" class="w-full text-left p-3 text-sm font-bold text-red-500 hover:bg-red-50">‡∏•‡∏ö‡∏≠‡∏≠‡∏Å</button>`}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function saveNote() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value || "00:00";

            if(!title || !date) return alert('‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô');
            const fullDateTime = `${date} ${time}:00`; 

            const payload = {
                name: user.name, 
                email: user.email,
                title: title,
                content: content,
                due_date: fullDateTime,
                sent_5d: false, sent_3d: false, sent_1d: false, sent_3h: false, sent_1h: false,
                is_deleted: false
            };
            
            const res = id ? await supabaseClient.from('note').update(payload).eq('id', id) : await supabaseClient.from('note').insert([payload]);
            
            if(!res.error) {
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                closeModal(); fetchNotes(); 
            }
        }

        async function togglePin(id, status) {
            await supabaseClient.from('note').update({ is_pinned: !status }).eq('id', id);
            fetchNotes();
        }

        async function toggleDone(id, status) {
            await supabaseClient.from('note').update({ is_done: !status }).eq('id', id);
            fetchNotes();
        }

        async function moveToTrash(id) {
            if(!confirm('‡∏¢‡πâ‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
            await supabaseClient.from('note').update({ is_deleted: true, is_pinned: false }).eq('id', id);
            fetchNotes();
        }

        async function restoreNote(id) {
            await supabaseClient.from('note').update({ is_deleted: false }).eq('id', id);
            fetchNotes();
        }

        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô";
            document.getElementById('edit-id').value = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('date').value = '';
            document.getElementById('time').value = '00:00';
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function editNote(n) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô";
            document.getElementById('edit-id').value = n.id;
            document.getElementById('title').value = n.title;
            document.getElementById('content').value = n.content;
            const parts = n.due_date.replace('T', ' ').split(' ');
            document.getElementById('date').value = parts[0];
            document.getElementById('time').value = parts[1] ? parts[1].substring(0, 5) : "00:00";
        }
    </script>
</body>
</html>
