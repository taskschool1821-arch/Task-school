<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task School - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){ emailjs.init("Isihs3VZwTT1xNymB"); })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .hidden { display: none; }
        .is-done { opacity: 0.5; text-decoration: line-through; }
        .note-card { transition: all 0.2s; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 12px; z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 120px; }
        .dropdown:focus-within .dropdown-content { display: block; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 15px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .guide-text { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
    </style>
</head>
<body>

    <div id="toast">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-blue-50">
            <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">Task School</h1>
            <input type="text" id="nickname" placeholder="Name" class="w-full p-4 mb-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <input type="email" id="email" placeholder="Email address" class="w-full p-4 mb-8 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-24">
        <nav class="bg-white p-5 border-b sticky top-0 z-40 shadow-sm">
            <div class="max-w-4xl mx-auto flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á <span id="user-name" class="text-gray-800"></span></h2>
                <button onclick="logout()" class="text-gray-400 text-xs font-bold uppercase tracking-widest">Logout</button>
            </div>
            <div class="max-w-4xl mx-auto flex gap-3 overflow-x-auto">
                <button id="btn-all" onclick="changeView('all')" class="px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md">‡πÇ‡∏ô‡πâ‡∏ï</button>
                <button id="btn-trash" onclick="changeView('trash')" class="px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ</button>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-4">
            <div id="note-list" class="flex flex-col gap-4"></div>
        </div>

        <div id="guide-tooltip" class="fixed bottom-28 right-6 z-50 flex flex-col items-center">
            <div class="bg-blue-600/80 text-white text-xs py-2 px-4 rounded-full shadow-lg guide-text backdrop-blur-sm">‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
            <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-blue-600/80"></div>
        </div>

        <button onclick="openModal()" class="fixed bottom-8 right-8 w-16 h-16 bg-blue-600 text-white rounded-full text-4xl shadow-2xl flex items-center justify-center transition hover:scale-110 z-50">+</button>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-6">‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full p-4 mb-3 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
            <textarea id="content" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full h-32 p-4 mb-3 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            
            <div class="grid grid-cols-2 gap-3 mb-8">
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-500 ml-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</label>
                    <input type="date" id="date" class="w-full p-4 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-500 ml-2">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <input type="time" id="time" class="w-full p-4 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex gap-4">
                <button type="button" onclick="closeModal()" class="flex-1 p-4 text-gray-400 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" onclick="saveNote()" id="btn-save" class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        const _URL = 'https://vapsoypudgmcxpayrtug.supabase.co';
        const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcHNveXB1ZGdtY3hwYXlydHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNDMzOTUsImV4cCI6MjA4NDYxOTM5NX0.AnD5YcWiDifHVARsCejbyxyzs_yggjE3o43UHxeQ5GM';
        const supabaseClient = supabase.createClient(_URL, _KEY);

        let user = { name: '', email: '' };
        let currentView = 'all';

        function playNotificationSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) { console.log("Audio block"); }
        }

        window.onload = function() {
            const savedUser = localStorage.getItem('task_school_user');
            if (savedUser) { user = JSON.parse(savedUser); showDashboard(); }
        };

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function login() {
            const name = document.getElementById('nickname').value;
            const email = document.getElementById('email').value;
            if(!name || !email) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            user = { name, email };
            localStorage.setItem('task_school_user', JSON.stringify(user));
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            fetchNotes();
        }

        function logout() {
            localStorage.removeItem('task_school_user');
            location.reload();
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-all').className = view === 'all' ? 'px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md' : 'px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold';
            document.getElementById('btn-trash').className = view === 'trash' ? 'px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md' : 'px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold';
            fetchNotes();
        }

        async function fetchNotes() {
            const isDeleted = currentView === 'trash';
            const { data } = await supabaseClient.from('note').select('*').eq('email', user.email).eq('is_deleted', isDeleted).order('due_date', {ascending: true});
            const list = document.getElementById('note-list');
            list.innerHTML = (data && data.length) ? '' : '<div class="text-center py-20 text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            
            if(data) data.forEach(n => {
                const dateObj = new Date(n.due_date);
                const displayDateTime = dateObj.toLocaleDateString('th-TH', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                list.innerHTML += `
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative note-card ${n.is_done ? 'is-done' : ''}">
                    <div class="flex items-start gap-4">
                        <input type="checkbox" ${n.is_done ? 'checked' : ''} onchange="toggleDone(${n.id}, ${n.is_done})" class="mt-1.5 w-6 h-6 rounded-full border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="flex-1">
                            <h4 class="font-bold text-xl mb-2 text-gray-800">${n.title}</h4>
                            <p class="text-gray-600 text-sm mb-6 whitespace-pre-wrap leading-relaxed">${n.content || ''}</p>
                            <div class="text-xs font-bold text-blue-500 bg-blue-50/50 inline-block px-4 py-1.5 rounded-full">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${displayDateTime}</div>
                        </div>
                        <div class="dropdown relative">
                            <button class="p-2 text-gray-300 hover:text-gray-600 text-2xl">‚ãÆ</button>
                            <div class="dropdown-content">
                                ${isDeleted ? `<button onclick="restoreNote(${n.id})" class="w-full text-left p-3 text-sm font-bold text-blue-500">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>` : 
                                `<button onclick='editNote(${JSON.stringify(n)})' class="w-full text-left p-3 text-sm font-bold text-gray-700 border-b">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                 <button onclick="moveToTrash(${n.id})" class="w-full text-left p-3 text-sm font-bold text-red-500">‡∏•‡∏ö</button>`}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }

        function openModal() {
            if(document.getElementById('guide-tooltip')) document.getElementById('guide-tooltip').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('edit-id').value = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('date').value = '';
            document.getElementById('time').value = '00:00';
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function saveNote() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value || "00:00";

            if(!title || !date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ Timezone ‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ Supabase
            const fullDateTime = `${date}T${time}:00`; 
            const dueDate = new Date(fullDateTime);
            const today = new Date();

            const payload = {
                name: user.name, 
                email: user.email,
                title: title,
                content: content,
                due_date: fullDateTime
            };
            
            const res = id ? await supabaseClient.from('note').update(payload).eq('id', id) : await supabaseClient.from('note').insert([payload]);
            
            if(!res.error) {
                playNotificationSound();
                
                const timeDiffMs = dueDate - today;
                const hoursLeft = Math.floor(timeDiffMs / (1000 * 60 * 60));
                const daysLeft = Math.floor(hoursLeft / 24);

                let timeMsg = "";
                if (hoursLeft < 0) timeMsg = "‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
                else if (hoursLeft < 24) timeMsg = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å ${hoursLeft} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
                else timeMsg = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô`;

                if (hoursLeft >= 0 && daysLeft <= 5) {
                    emailjs.send("service_xpfnqyd", "template_9qrfhh6", {
                        nickname: user.name,
                        title: title,
                        due_date: dueDate.toLocaleString('th-TH'),
                        days_left: timeMsg, // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡πÉ‡∏´‡πâ EmailJS
                        to_email: user.email
                    }).then(() => {
                        showToast(`‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${timeMsg} ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß!`);
                    });
                } else {
                    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                }
                closeModal(); fetchNotes(); 
            }
        }

        async function toggleDone(id, status) {
            await supabaseClient.from('note').update({ is_done: !status }).eq('id', id);
            fetchNotes();
        }

        async function moveToTrash(id) {
            if(!confirm('‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞?')) return;
            await supabaseClient.from('note').update({ is_deleted: true }).eq('id', id);
            fetchNotes();
        }

        async function restoreNote(id) {
            await supabaseClient.from('note').update({ is_deleted: false }).eq('id', id);
            fetchNotes();
        }

        function editNote(n) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('edit-id').value = n.id;
            document.getElementById('title').value = n.title;
            document.getElementById('content').value = n.content;
            const dt = new Date(n.due_date);
            document.getElementById('date').value = dt.toISOString().split('T')[0];
            document.getElementById('time').value = dt.toTimeString().substring(0,5);
        }
    </script>
</body>
</html>
