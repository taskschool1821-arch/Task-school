<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task School - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){ emailjs.init("Isihs3VZwTT1xNymB"); })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .hidden { display: none; }
        .is-done { opacity: 0.5; text-decoration: line-through; }
        .note-card { transition: all 0.2s; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 12px; z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 120px; }
        .dropdown:focus-within .dropdown-content { display: block; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 15px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        .guide-text { animation: bounceSide 2s infinite; }
        @keyframes bounceSide {
            0%, 20%, 50%, 80%, 100% { transform: translateX(0); }
            40% { transform: translateX(-10px); }
            60% { transform: translateX(-5px); }
        }
    </style>
</head>
<body>

    <div id="toast">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-blue-50">
            <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">Task School</h1>
            <input type="text" id="nickname" placeholder="Name" class="w-full p-4 mb-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <input type="email" id="email" placeholder="Email address" class="w-full p-4 mb-8 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-24">
        <nav class="bg-white p-5 border-b sticky top-0 z-40 shadow-sm">
            <div class="max-w-4xl mx-auto flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á <span id="user-name" class="text-gray-800"></span></h2>
                <button onclick="logout()" class="text-gray-400 text-xs font-bold uppercase tracking-widest">Logout</button>
            </div>
            <div class="max-w-4xl mx-auto flex gap-3 overflow-x-auto">
                <button id="btn-all" onclick="changeView('all')" class="px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md">‡πÇ‡∏ô‡πâ‡∏ï</button>
                <button id="btn-trash" onclick="changeView('trash')" class="px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ</button>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-4">
            <div id="note-list" class="flex flex-col gap-4"></div>
        </div>

        <div class="fixed bottom-8 right-8 flex items-center gap-3 z-[110]">
            <span class="guide-text text-gray-400 text-sm font-bold bg-white/80 px-3 py-1 rounded-full shadow-sm border border-gray-100">‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            <button onclick="openModal()" class="w-16 h-16 bg-blue-600 text-white rounded-full text-4xl shadow-2xl flex items-center justify-center transition hover:scale-110 active:scale-95">+</button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[200] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-6">‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full p-4 mb-3 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
            <textarea id="content" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full h-32 p-4 mb-3 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            
            <div class="grid grid-cols-2 gap-3 mb-8">
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-500 ml-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</label>
                    <input type="date" id="date" class="w-full p-4 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-500 ml-2">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <input type="time" id="time" class="w-full p-4 border border-gray-100 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex gap-4">
                <button type="button" onclick="closeModal()" class="flex-1 p-4 text-gray-400 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" onclick="saveNote()" id="btn-save" class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        const _URL = 'https://vapsoypudgmcxpayrtug.supabase.co';
        const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcHNveXB1ZGdtY3hwYXlydHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNDMzOTUsImV4cCI6MjA4NDYxOTM5NX0.AnD5YcWiDifHVARsCejbyxyzs_yggjE3o43UHxeQ5GM';
        const supabaseClient = supabase.createClient(_URL, _KEY);

        let user = { name: '', email: '' };
        let currentView = 'all';

        function playNotificationSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) { console.log("Audio block"); }
        }

        window.onload = function() {
            const savedUser = localStorage.getItem('task_school_user');
            if (savedUser) { user = JSON.parse(savedUser); showDashboard(); }
        };

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function login() {
            const name = document.getElementById('nickname').value;
            const email = document.getElementById('email').value;
            if(!name || !email) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            user = { name, email };
            localStorage.setItem('task_school_user', JSON.stringify(user));
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            fetchNotes();
        }

        function logout() {
            localStorage.removeItem('task_school_user');
            location.reload();
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-all').className = view === 'all' ? 'px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md' : 'px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold';
            document.getElementById('btn-trash').className = view === 'trash' ? 'px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-md' : 'px-5 py-2 rounded-full bg-gray-100 text-gray-500 text-sm font-bold';
            fetchNotes();
        }

        async function fetchNotes() {
            const isDeleted = currentView === 'trash';
            const { data } = await supabaseClient
                .from('note')
                .select('*')
                .eq('email', user.email)
                .eq('is_deleted', isDeleted)
                .order('is_pinned', { ascending: false })
                .order('due_date', { ascending: true });

            const list = document.getElementById('note-list');
            list.innerHTML = (data && data.length) ? '' : '<div class="text-center py-20 text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            
            if(data) data.forEach(n => {
                const rawDate = n.due_date.replace('T', ' ');
                const [d, t] = rawDate.split(' ');
                const [y, m, day] = d.split('-');
                const displayTime = t ? t.substring(0, 5) : "00:00";
                const displayDateTime = `${day}/${m}/${parseInt(y)+543} ${displayTime}`;

                list.innerHTML += `
                <div class="bg-white p-6 rounded-3xl border ${n.is_pinned ? 'border-blue-300 ring-2 ring-blue-50' : 'border-gray-100'} shadow-sm relative note-card ${n.is_done ? 'is-done' : ''}">
                    ${n.is_pinned ? '<span class="absolute -top-2 -left-2 bg-blue-500 text-white text-[10px] px-2 py-1 rounded-lg font-bold">PINNED</span>' : ''}
                    <div class="flex items-start gap-4">
                        <input type="checkbox" ${n.is_done ? 'checked' : ''} onchange="toggleDone(${n.id}, ${n.is_done})" class="mt-1.5 w-6 h-6 rounded-full border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="flex-1">
                            <h4 class="font-bold text-xl mb-2 text-gray-800">${n.title}</h4>
                            <p class="text-gray-600 text-sm mb-6 whitespace-pre-wrap leading-relaxed">${n.content || ''}</p>
                            <div class="text-xs font-bold text-blue-500 bg-blue-50/50 inline-block px-4 py-1.5 rounded-full">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${displayDateTime}</div>
                        </div>
                        <div class="dropdown relative">
                            <button class="p-2 text-gray-300 hover:text-gray-600 text-2xl">‚ãÆ</button>
                            <div class="dropdown-content">
                                ${isDeleted ? `<button onclick="restoreNote(${n.id})" class="w-full text-left p-3 text-sm font-bold text-blue-500">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>` : 
                                `<button onclick="togglePin(${n.id}, ${n.is_pinned})" class="w-full text-left p-3 text-sm font-bold text-blue-600 border-b">${n.is_pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î'}</button>
                                 <button onclick='editNote(${JSON.stringify(n)})' class="w-full text-left p-3 text-sm font-bold text-gray-700 border-b">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                 <button onclick="moveToTrash(${n.id})" class="w-full text-left p-3 text-sm font-bold text-red-500">‡∏•‡∏ö</button>`}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function saveNote() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value || "00:00";

            if(!title || !date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            const fullDateTime = `${date} ${time}:00`; 

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
            const payload = {
                name: user.name, 
                email: user.email,
                title: title,
                content: content,
                due_date: fullDateTime,
                sent_5d: false, // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 5 ‡∏ß‡∏±‡∏ô
                sent_3d: false, // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 3 ‡∏ß‡∏±‡∏ô
                sent_1d: false, // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 1 ‡∏ß‡∏±‡∏ô
                sent_3h: false, // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 3 ‡∏ä‡∏°.
                sent_1h: false  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 1 ‡∏ä‡∏°.
            };
            
            const res = id ? await supabaseClient.from('note').update(payload).eq('id', id) : await supabaseClient.from('note').insert([payload]);
            
            if(!res.error) {
                playNotificationSound();
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                closeModal(); fetchNotes(); 
            }
        }

        async function togglePin(id, status) {
            await supabaseClient.from('note').update({ is_pinned: !status }).eq('id', id);
            fetchNotes();
        }

        async function toggleDone(id, status) {
            await supabaseClient.from('note').update({ is_done: !status }).eq('id', id);
            fetchNotes();
        }

        async function moveToTrash(id) {
            if(!confirm('‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞?')) return;
            await supabaseClient.from('note').update({ is_deleted: true, is_pinned: false }).eq('id', id);
            fetchNotes();
        }

        async function restoreNote(id) {
            await supabaseClient.from('note').update({ is_deleted: false }).eq('id', id);
            fetchNotes();
        }

        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô";
            document.getElementById('edit-id').value = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('date').value = '';
            document.getElementById('time').value = '00:00';
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function editNote(n) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô";
            document.getElementById('edit-id').value = n.id;
            document.getElementById('title').value = n.title;
            document.getElementById('content').value = n.content;
            const parts = n.due_date.replace('T', ' ').split(' ');
            document.getElementById('date').value = parts[0];
            document.getElementById('time').value = parts[1] ? parts[1].substring(0, 5) : "00:00";
        }
    </script>
</body>
</html>
